<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Transfer Function Editor</title>
    <script src="libraries/d3.v3.min.js" type="text/javascript"></script>
    <script src="libraries/wampy-all.min.js" type="text/javascript"></script>
    <script src="scripts/tf_utils.js" type="text/javascript"></script>
    <script src="scripts/tf_editor.js" type="text/javascript"></script>

    <style type="text/css">
    /* http://meyerweb.com/eric/tools/css/reset/
       v2.0 | 20110126
       License: none (public domain)
    */

    html, body, div, span, applet, object, iframe,
    h1, h2, h3, h4, h5, h6, p, blockquote, pre,
    a, abbr, acronym, address, big, cite, code,
    del, dfn, em, img, ins, kbd, q, s, samp,
    small, strike, strong, sub, sup, tt, var,
    b, u, i, center,
    dl, dt, dd, ol, ul, li,
    fieldset, form, label, legend,
    table, caption, tbody, tfoot, thead, tr, th, td,
    article, aside, canvas, details, embed,
    figure, figcaption, footer, header, hgroup,
    menu, nav, output, ruby, section, summary,
    time, mark, audio, video {
        margin: 0;
        padding: 0;
        border: 0;
        font-size: 100%;
        font: inherit;
        vertical-align: baseline;
    }
    /* HTML5 display-role reset for older browsers */
    article, aside, details, figcaption, figure,
    footer, header, hgroup, menu, nav, section {
        display: block;
    }
    body {
        line-height: 1;
    }
    ol, ul {
        list-style: none;
    }
    blockquote, q {
        quotes: none;
    }
    blockquote:before, blockquote:after,
    q:before, q:after {
        content: '';
        content: none;
    }
    table {
        border-collapse: collapse;
        border-spacing: 0;
    }
    </style>
    <style type="text/css">
    body {
        overflow: hidden;
        background: black;
        font-size: 12px;
        line-height: 12px;
        color: #AAA;
        -webkit-user-select: none;
    }
    .tf_editor { -webkit-user-select: none; }
    .tf_editor .axis path,
    .tf_editor .axis line {
        fill: none;
        stroke: #888;
        shape-rendering: crispEdges;
    }
    .tf_editor .axis text {
        font-family: sans-serif;
        font-size: 12px;
        fill: #888;
    }
    .tf_editor .axis_upper path,
    .tf_editor .axis_upper line {
        fill: none;
        stroke: #888;
        shape-rendering: crispEdges;
    }
    .tf_editor .axis_upper text {
        stroke: none; fill: none;
    }
    .tf_editor {
        color: #AAA;
        font-size: 12px;
        line-height: 12px;
    }
    .tf_editor .graphics {
        padding-top: 10px;
        position: relative;
    }
    .tf_editor canvas {
        position: absolute;
        left: 0; top: 0;
    }
    .tf_editor svg {
        position: absolute;
        left: 0; top: 0;
    }
    .tf_editor .controls {
        padding: 20px;
    }
    input { width: 6em; }
    input,
    select {
        border: none; outline: none;
        background: none;
        padding: 2px 4px;
        margin: 0px 4px;
        border: 1px solid #AAA;
        line-height: 14px;
        color: white;
        border-radius: 0;
    }
    .buttons {
        margin: 5px 0px;
    }
    .buttons .sep {
        display: inline-block;
        width: 5px;
    }
    .btn {
        padding: 2px 4px;
        border: 1px solid #AAA;
        margin: 0px 4px;
        cursor: pointer;
    }
    .btn:hover {
        background-color: rgba(255, 255, 255, 0.3);
        color: white;
        border: 1px solid white;
    }
    .renderer-controls {
        padding: 10px 20px;
    }
    .slider .axis path,
    .slider .axis line {
        fill: none;
        stroke: #888;
        shape-rendering: crispEdges;
    }
    .slider .axis text {
        font-family: sans-serif;
        font-size: 9px;
        fill: #888;
    }
    div.slider {
        margin: 5px 0px;
    }
    div.slider span {
        line-height: 30px;
        vertical-align: top;
    }
    </style>
  </head>
  <body>
    <div class="renderer-controls">
        <div class="slider"><span>Blending Coeff.: </span><span id="slider-blending-coefficient"></span></div>
        <div class="slider"><span>Focal Distance.: </span><span id="slider-focal-distance"></span></div>
        <div class="slider"><span>Levels: </span><span id="slider-levels"></span></div>
        <div class="buttons">
            Blending Method:
            <select id="sel-rendering-method">
                <option value="BasicBlending">Basic Blending</option>
                <option value="RK4">RK4</option>
                <option value="AdaptiveRKV">AdaptiveRKV</option>
            </select>
        </div>
    </div>
    <div id="tf_editor" class="tf_editor"></div>
    <script type="text/javascript">
        var editor = new TransferFunctionEditor(d3.select("#tf_editor"));
        d3.select(window).on("resize", function() {
            editor.resize();
        });
        document.body.addEventListener('touchmove', function(event) {
            event.preventDefault();
        }, false);
        var wamp = new Wampy("/ws", { realm: "anonymous" });
        var response_t = {
            onSuccess: function() {
                console.log('RPC successfully called');
            },
            onError: function(err) {
                console.log('RPC call failed with error ' + err);
            }
        };
        editor.onTransferFunctionChanged = function(tf) {
            wamp.call('allovolume.renderer.set_transfer_function', { tf: tf }, response_t);
        }

        var Slider = function(container, scale, min, max, value) {
            var self = this;

            this.value = value;

            var width = 500;
            var svg = container.append("svg").attr("class", "slider");
            svg.style("width", width + "px");
            svg.style("height", "30px");
            var scale = scale == "linear" ? d3.scale.linear() : d3.scale.log();
            scale.domain([ min, max ]);
            scale.range([ 20, width - 20 ]);
            var axis = d3.svg.axis().scale(scale).orient("bottom").tickPadding(3).innerTickSize(2).outerTickSize(4);
            svg.append("g").attr("transform", "translate(0, 18)").attr("class", "axis").call(axis);
            var control = svg.append("path").attr("d", glyph_droplet(-10, -10)).attr("fill", "#AAA");
            var render = function() {
                control.attr("transform", "translate(" + scale(self.value) + ", 18)");
            };
            var did_change = function() {
                if(self.onChange) {
                    self.onChange(self.value);
                }
            };
            var drag = d3.behavior.drag();

            control.call(drag);
            drag.on("drag", function() {
                var x = d3.event.x;
                self.value = Math.max(min, Math.min(max, scale.invert(x)));
                did_change();
                render();
            });
            render();

            self.set = function(value) {
                self.value = value;
                render();
            };
        };

        var SliderLevels = function(container) {
            var self = this;

            this.min = 0;
            this.max = 1;
            this.pow = 1;

            var width = 500;
            var svg = container.append("svg").attr("class", "slider");
            svg.style("width", width + "px");
            svg.style("height", "30px");
            var scale = d3.scale.linear();
            scale.domain([ 0, 1 ]);
            scale.range([ 20, width - 20 ]);
            var axis = d3.svg.axis().scale(scale).orient("bottom").tickPadding(3).innerTickSize(2).outerTickSize(4);
            svg.append("g").attr("transform", "translate(0, 18)").attr("class", "axis").call(axis);
            var control_min = svg.append("path").attr("d", glyph_droplet(-10, -10)).attr("fill", "#AAA");
            var control_max = svg.append("path").attr("d", glyph_droplet(-10, -10)).attr("fill", "#AAA");
            var control_pow = svg.append("path").attr("d", glyph_droplet(-10, -10)).attr("fill", "#AAA");
            var render = function() {
                control_min.attr("transform", "translate(" + scale(self.min) + ", 18)");
                control_max.attr("transform", "translate(" + scale(self.max) + ", 18)");
                control_pow.attr("transform", "translate(" + scale(Math.pow(2, -1.0 / self.pow) * (self.max - self.min) + self.min) + ", 18)");
            };
            var did_change = function() {
                if(self.onChange) {
                    self.onChange(self.min, self.max, self.pow);
                }
            };
            control_min.call(d3.behavior.drag().on("drag", function() {
                var x = d3.event.x;
                self.min = Math.max(0, Math.min(1, scale.invert(x)));
                did_change();
                render();
            }));
            control_max.call(d3.behavior.drag().on("drag", function() {
                var x = d3.event.x;
                self.max = Math.max(0, Math.min(1, scale.invert(x)));
                did_change();
                render();
            }));
            control_pow.call(d3.behavior.drag().on("drag", function() {
                var x = d3.event.x;
                self.pow = -Math.log(2) / Math.log((scale.invert(x) - self.min) / (self.max - self.min));
                if(self.pow != self.pow) self.pow = 10;
                if(self.pow > 100) self.pow = 100;
                did_change();
                render();
            }));
            self.set = function(min, max, pow) {
                self.min = min;
                self.max = max;
                self.pow = pow;
                render();
            };
            render();
        };

        var sl_blending_coefficient = new Slider(d3.select("#slider-blending-coefficient"), "log", 1e-2, 1e10, 1e9);
        var sl_focal_distance = new Slider(d3.select("#slider-focal-distance"), "log", 1e-2, 1e10, 5e8);
        sl_blending_coefficient.onChange = function(value) {
            wamp.call("allovolume.renderer.set_renderer_parameters", { blending_coefficient: value, method: d3.select("#sel-rendering-method").node().value }, response_t);
        };

        var sl_levels_max = new SliderLevels(d3.select("#slider-levels"));
        sl_levels_max.onChange = function(min, max, pow) {
            wamp.call("allovolume.renderer.set_rgb_levels", { min: min, max: max, pow: pow }, response_t);
        };
    </script>
  </body>
</html>
