var Gradients = {
    "rainbow": { name: "Rainbow", values: [
        [ 0.471412, 0.108766, 0.527016 ],
        [ 0.274861, 0.182264, 0.727279 ],
        [ 0.248488, 0.386326, 0.813373 ],
        [ 0.297960, 0.565793, 0.752239 ],
        [ 0.388225, 0.674195, 0.603544 ],
        [ 0.513417, 0.729920, 0.440682 ],
        [ 0.666083, 0.743042, 0.322935 ],
        [ 0.808342, 0.711081, 0.255976 ],
        [ 0.893514, 0.600415, 0.220546 ],
        [ 0.892955, 0.389662, 0.179401 ],
        [ 0.857359, 0.131106, 0.132128 ]
    ] },
    "temperature": { name: "Temperature", values: [
        [ 0.178927, 0.305394, 0.933501 ],
        [ 0.337660, 0.466886, 0.942736 ],
        [ 0.528934, 0.628452, 0.956059 ],
        [ 0.748934, 0.803792, 0.975610 ],
        [ 0.912556, 0.933111, 0.991522 ],
        [ 0.984192, 0.987731, 0.911643 ],
        [ 0.994726, 0.991128, 0.667358 ],
        [ 0.977887, 0.937070, 0.368596 ],
        [ 0.924921, 0.740045, 0.258448 ],
        [ 0.867569, 0.491545, 0.211209 ],
        [ 0.817319, 0.134127, 0.164218 ]
    ] },
    "bright-bands": { name: "BrightBands", values: [
        [0.90222,0.101808,0.198306],
        [0.90666,0.124542,0.223391],
        [0.9111,0.147276,0.248475],
        [0.915539,0.17001,0.27356],
        [0.919979,0.192743,0.298645],
        [0.924419,0.215477,0.32373],
        [0.928859,0.238211,0.348814],
        [0.933299,0.260945,0.373899],
        [0.937738,0.283679,0.398984],
        [0.942178,0.306413,0.424068],
        [0.946618,0.329146,0.449153],
        [0.951058,0.35188,0.474238],
        [0.955498,0.374614,0.499322],
        [0.959937,0.397348,0.524407],
        [0.964377,0.420082,0.549492],
        [0.968817,0.442816,0.574577],
        [0.973257,0.46555,0.599661],
        [0.977697,0.488283,0.624746],
        [0.982136,0.511017,0.649831],
        [0.986576,0.533751,0.674915],
        [0.991016,0.556485,0.7],
        [0.995456,0.579219,0.725085],
        [0.999896,0.601953,0.750169],
        [0.416681,0.320056,0.999984],
        [0.433155,0.338462,0.999968],
        [0.449628,0.356868,0.999951],
        [0.466102,0.375273,0.999935],
        [0.482575,0.393679,0.999919],
        [0.499048,0.412085,0.999902],
        [0.515522,0.430491,0.999886],
        [0.531995,0.448897,0.99987],
        [0.548469,0.467302,0.999853],
        [0.564942,0.485708,0.999837],
        [0.581416,0.504114,0.999821],
        [0.597889,0.52252,0.999804],
        [0.614362,0.540925,0.999788],
        [0.630836,0.559331,0.999771],
        [0.647309,0.577737,0.999755],
        [0.663783,0.596143,0.999739],
        [0.680256,0.614549,0.999722],
        [0.69673,0.632954,0.999706],
        [0.713203,0.65136,0.99969],
        [0.729676,0.669766,0.999673],
        [0.74615,0.688172,0.999657],
        [0.762623,0.706577,0.999641],
        [0.779097,0.724983,0.999624],
        [0.79557,0.743389,0.999608],
        [0.120299,0.706992,1.],
        [0.142872,0.71655,1.],
        [0.165446,0.726107,1.],
        [0.188019,0.735664,1.],
        [0.210593,0.745222,1.],
        [0.233167,0.754779,1.],
        [0.25574,0.764336,1.],
        [0.278314,0.773894,1.],
        [0.300887,0.783451,1.],
        [0.323461,0.793008,1.],
        [0.346035,0.802566,1.],
        [0.368608,0.812123,1.],
        [0.391182,0.82168,1.],
        [0.413756,0.831238,1.],
        [0.436329,0.840795,1.],
        [0.458903,0.850352,1.],
        [0.481476,0.85991,1.],
        [0.50405,0.869467,1.],
        [0.526624,0.879024,1.],
        [0.549197,0.888582,1.],
        [0.571771,0.898139,1.],
        [0.594344,0.907696,1.],
        [0.616918,0.917254,1.],
        [0.639492,0.926811,1.],
        [0.214205,0.966221,0.0967507],
        [0.234991,0.967604,0.115633],
        [0.255777,0.968986,0.134515],
        [0.276563,0.970368,0.153398],
        [0.297349,0.971751,0.17228],
        [0.318135,0.973133,0.191162],
        [0.338921,0.974515,0.210044],
        [0.359708,0.975898,0.228927],
        [0.380494,0.97728,0.247809],
        [0.40128,0.978663,0.266691],
        [0.422066,0.980045,0.285574],
        [0.442852,0.981427,0.304456],
        [0.463638,0.98281,0.323338],
        [0.484424,0.984192,0.342221],
        [0.50521,0.985575,0.361103],
        [0.525996,0.986957,0.379985],
        [0.546782,0.988339,0.398868],
        [0.567568,0.989722,0.41775],
        [0.588354,0.991104,0.436632],
        [0.60914,0.992486,0.455514],
        [0.629926,0.993869,0.474397],
        [0.650712,0.995251,0.493279],
        [0.671498,0.996634,0.512161],
        [0.692284,0.998016,0.531044],
        [0.71307,0.999398,0.549926],
        [0.972919,0.939126,0.201749],
        [0.974061,0.940711,0.218465],
        [0.975202,0.942296,0.235181],
        [0.976344,0.943881,0.251897],
        [0.977486,0.945465,0.268613],
        [0.978628,0.94705,0.285329],
        [0.97977,0.948635,0.302045],
        [0.980911,0.95022,0.318761],
        [0.982053,0.951805,0.335477],
        [0.983195,0.95339,0.352193],
        [0.984337,0.954974,0.368909],
        [0.985479,0.956559,0.385625],
        [0.986621,0.958144,0.402341],
        [0.987762,0.959729,0.419057],
        [0.988904,0.961314,0.435773],
        [0.990046,0.962899,0.452489],
        [0.991188,0.964484,0.469205],
        [0.99233,0.966068,0.485921],
        [0.993471,0.967653,0.502638],
        [0.994613,0.969238,0.519354],
        [0.995755,0.970823,0.53607],
        [0.996897,0.972408,0.552786],
        [0.998039,0.973993,0.569502],
        [0.999181,0.975578,0.586218],
        [1.,0.503408,0.00606769],
        [1.,0.513673,0.0266975],
        [1.,0.523937,0.0473273],
        [1.,0.534201,0.0679571],
        [1.,0.544466,0.0885869],
        [1.,0.55473,0.109217],
        [1.,0.564994,0.129847],
        [1.,0.575259,0.150476],
        [1.,0.585523,0.171106],
        [1.,0.595787,0.191736],
        [1.,0.606052,0.212366],
        [1.,0.616316,0.232996],
        [1.,0.62658,0.253625],
        [1.,0.636845,0.274255],
        [1.,0.647109,0.294885],
        [1.,0.657373,0.315515],
        [1.,0.667637,0.336145],
        [1.,0.677902,0.356774],
        [1.,0.688166,0.377404],
        [1.,0.69843,0.398034],
        [1.,0.708695,0.418664],
        [1.,0.718959,0.439294],
        [1.,0.729223,0.459923],
        [1.,0.739488,0.480553],
        [1.,0.749752,0.501183]
    ] }
};

var Colors = [
  "000000", "ffffff", "888888" ,"1f77b4", "ff7f0e", "2ca02c", "d62728", "9467bd", "8c564b", "e377c2", "bcbd22", "17becf",
  "BD0026", "F03B20", "FD8D3C" ,"FEB24C", "FED976", "FFFFB2", "045A8D", "2B8CBE", "74A9CF", "A6BDDB", "D0D1E6", "F1EEF6",
  "0A4404", "2B681A", "528D38" ,"7FB35C", "B3D787", "EEFBBA", "4F0555", "7C257E", "A64BA1", "CB77BB", "E9A8CB", "FDDDD0",
  "252525", "636363", "969696" ,"BDBDBD", "D9D9D9", "F7F7F7", "B2182B", "EF8A62", "FDDBC7", "D1E5F0", "67A9CF", "2166AC"
].map(function(str) {
    var r = eval("0x" + str.substr(0, 2));
    var g = eval("0x" + str.substr(2, 2));
    var b = eval("0x" + str.substr(4, 2));
    return [ r / 255, g / 255, b / 255 ];
});

var PopupBox = function() {
    var self = this;
    this.container = d3.select("body").append("div");
    this.container.style({
        "position": "absolute",
        "z-index": 1000,
        "left": "0px",
        "top": "0px",
        "width": "320px",
        "display": "none"
    })
    .attr("class", "popup-container");
    this.content = this.container.append("div");
};
PopupBox.prototype.show = function(x, y) {
    this.container.style({
        "left": x + "px",
        "top": y + "px",
        "display": "block"
    });
};
PopupBox.prototype.destroy = function() {
    this.container.remove();
};

var ColorPicker = function(x, y) {
    var self = this;
    this.box = new PopupBox();
    var colors = this.box.content.append("div");
    colors.selectAll("span")
        .data(Colors).enter().append("span")
        .attr("class", "color btn")
        .style({
            "display": "inline-block",
            "width": "1em",
            "height": "1em",
            "margin": "0.4em 2px"
        })
        .style("background-color", function(d) { return rgba_color(array_to_color(d)) })
        .on("click", function(d) {
            self.box.destroy();
            if(self.onSelectColor) self.onSelectColor(d);
        });
    this.box.show(x, y);
};

var clamp = function(val, min, max) {
    return val < min ? min : (val > max ? max : val);
};

var sample_gradient = function(gradient, t) {
    var pos = t * gradient.length;
    var i = parseInt(Math.floor(pos));
    if(i < 0) i = 0;
    if(i >= gradient.length - 1) i = gradient.length - 2;
    var k = pos - i;
    return {
        r: gradient[i][0] * (1 - k) + gradient[i + 1][0] * k,
        g: gradient[i][1] * (1 - k) + gradient[i + 1][1] * k,
        b: gradient[i][2] * (1 - k) + gradient[i + 1][2] * k,
        a: 1.0
    };
};

var array_to_color = function(a) {
    return { r: a[0], g: a[1], b: a[2], a: a[3] === undefined ? 1.0 : a[3] };
};

var rgba_color = function(c, alpha) {
    var r = Math.max(0, Math.min(255, parseInt(c.r * 255)));
    var g = Math.max(0, Math.min(255, parseInt(c.g * 255)));
    var b = Math.max(0, Math.min(255, parseInt(c.b * 255)));
    var a = Math.max(0, Math.min(1, c.a.toFixed(3)));
    if(alpha !== undefined) a = alpha;
    return "rgba(" + r + "," + g + "," + b + "," + a + ")";
};

var blend_color = function(src, dest) {
    var result = {
        r: dest.r * (1 - src.a) * dest.a + src.r * src.a,
        g: dest.g * (1 - src.a) * dest.a + src.g * src.a,
        b: dest.b * (1 - src.a) * dest.a + src.b * src.a,
        a: dest.a * (1 - src.a) + src.a
    };
    if(result.a != 0) {
        result.r /= result.a;
        result.g /= result.a;
        result.b /= result.a;
        return result;
    } else {
        return { r: 0, g: 0, b: 0, a: 0 };
    }
};
